name: Aggregate Multiple Repo Docs

on:
  workflow_dispatch:
  push:
    branches:
      - "**"
  schedule:
    - cron: "0 0 * * *"

env:
  GITHUB_ORG: phylaxsystems
  REPO_LIST: '["phylax-monitor", "phylax-std"]'

jobs:
  aggregate-docs:
    runs-on: ubuntu-latest
    name: Aggregate docs from multiple repos
    steps:
      - name: Checkout docs repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}
          fetch-depth: 0

      - name: Get current branch name
        id: branch-name
        uses: tj-actions/branch-names@v8

      - name: Fetch docs from multiple repos
        run: |
          REPOS=$(echo $REPO_LIST | jq -r '.[]')
          CURRENT_BRANCH="${{ steps.branch-name.outputs.current_branch }}"
          echo "Current branch: $CURRENT_BRANCH"

          for repo in $REPOS; do
            echo "Fetching docs from $repo"
            git clone --depth 1 --filter=blob:none --sparse https://${{ secrets.GH_TOKEN }}@github.com/${{ env.GITHUB_ORG }}/$repo.git temp/$repo
            cd temp/$repo
            git sparse-checkout set docs

            # Try to checkout branches in this order: current branch, main, master, default branch
            if git checkout $CURRENT_BRANCH 2>/dev/null; then
              echo "Checked out $CURRENT_BRANCH in $repo"
            elif git checkout main 2>/dev/null; then
              echo "Checked out main in $repo"
            elif git checkout master 2>/dev/null; then
              echo "Checked out master in $repo"
            else
              DEFAULT_BRANCH=$(git symbolic-ref refs/remotes/origin/HEAD | sed 's@^refs/remotes/origin/@@')
              if git checkout $DEFAULT_BRANCH 2>/dev/null; then
                echo "Checked out $DEFAULT_BRANCH (default branch) in $repo"
              else
                echo "Failed to checkout any branch in $repo. Using current HEAD."
                echo "Available branches:"
                git branch -r
              fi
            fi

            cd ../..
            echo "Contents of temp/$repo/docs:"
            ls -R temp/$repo/docs || echo "No docs directory found in $repo"
          done

      - name: Organize docs
        run: |
          REPOS=$(echo $REPO_LIST | jq -r '.[]')
          for repo in $REPOS; do
            mkdir -p $repo
            if [ -d "temp/$repo/docs" ]; then
              cp -R temp/$repo/docs/* $repo/
              echo "Copied docs from $repo"
            else
              echo "No docs folder found in $repo"
            fi
          done
          rm -rf temp

      - name: Update mint.json
        run: |
          # Implement logic to update mint.json
          echo "Updating mint.json"
          # Add your mint.json update logic here

      - name: Get commit message
        id: get-commit-message
        run: |
          echo "commit_message=$(git log -1 --pretty=%B)" >> $GITHUB_OUTPUT

      - name: Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: |
            Update docs from multiple repos
          file_pattern: "**/*"
          branch: ${{ steps.branch-name.outputs.current_branch }}
