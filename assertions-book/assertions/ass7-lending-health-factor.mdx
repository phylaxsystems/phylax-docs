---
title: Lending Health Factor
description: Assert that the health factor of a lending protocol is above a certain threshold
---

## Use Case
Check that the health factor of a position in a lending protocol is above a certain threshold.
In this specific example we use Morpho as a lending protocol, but this could be any lending protocol.

## Explanation
The health factor is a measure of the riskiness of a position in a lending protocol. It is calculated as the ratio of the total value of the collateral to the total value of the debt.

## Code Example
```solidity
// SPDX-License-Identifier: MIT
pragma solidity 0.8.28;

import {Assertion} from "../../lib/credible-std/src/Assertion.sol";
import {PhEvm} from "../../lib/credible-std/src/PhEvm.sol";

// We use Morpho as an example, but this could be any lending protocol
interface IMorpho {
    struct MarketParams {
        Id id;
    }

    struct Id {
        uint256 marketId;
    }

    function _isHealthy(MarketParams memory marketParams, Id memory id, address borrower)
        external
        view
        returns (bool);

    function withdrawCollateral(MarketParams memory marketParams, uint256 assets, address receiver) external;
}

contract LendingHealthFactorAssertion is Assertion {
    IMorpho public morpho = IMorpho(address(0xbeef));

    function fnSelectors() external pure override returns (bytes4[] memory assertions) {
        assertions = new bytes4[](1);
        assertions[0] = this.assertionHealthFactor.selector;
    }

    // Check that the position is still healthy after the transaction
    // This check only works for the withdrawCollateral function from Morpho
    // Morpho correctly checks the health factor in the withdrawCollateral function,
    // but if we assume that the check was mistakenly not done, this assertion could
    // be used to check if the health factor is still healthy after the transaction
    // return true indicates a valid state
    // return false indicates an invalid state
    function assertionHealthFactor() external {
        ph.forkPostState();
        PhEvm.CallInputs[] memory callInputs = ph.getCallInputs(address(morpho), morpho.withdrawCollateral.selector);
        if (callInputs.length == 0) {
            return; // Skip the assertion if the function is not withdrawCollateral
        }

        for (uint256 i = 0; i < callInputs.length; i++) {
            bytes memory data = callInputs[i].input;
            // Skip the first 4 bytes (function selector) by passing the full calldata to decode
            (IMorpho.MarketParams memory marketParams, , address onBehalf,) =
                abi.decode(stripSelector(data), (IMorpho.MarketParams, uint256, address, address));

            require(morpho._isHealthy(marketParams, marketParams.id, onBehalf), "Health factor is not healthy");
        }
    }

    function stripSelector(bytes memory input) internal pure returns (bytes memory) {
        // Create a new bytes memory and copy everything after the selector
        bytes memory paramData = new bytes(32);
        for (uint256 i = 4; i < input.length; i++) {
            paramData[i - 4] = input[i];
        }
        return paramData;
    }
}

```